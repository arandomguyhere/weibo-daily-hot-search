<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weibo Signal Tracker</title>
    <meta name="description" content="Weibo narrative signal tracker - trending topics with velocity and lifecycle analysis">
    <style>
        :root {
            --primary-color: #ff8200;
            --primary-dark: #e67300;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --hot-color: #ff4d4f;
            --hover-bg: #fafafa;
            --input-bg: #ffffff;
            --new-color: #722ed1;
            --rising-color: #52c41a;
            --falling-color: #faad14;
            --gone-color: #8c8c8c;
        }

        [data-theme="dark"] {
            --primary-color: #ff9a33;
            --primary-dark: #ff8200;
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-color: #2a2a4a;
            --hot-color: #ff6b6b;
            --hover-bg: #1a2744;
            --input-bg: #16213e;
            --new-color: #b37feb;
            --rising-color: #95de64;
            --falling-color: #ffd666;
            --gone-color: #595959;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            margin-bottom: 30px;
            border-radius: 0 0 20px 20px;
            position: relative;
        }

        header h1 { font-size: 2rem; margin-bottom: 10px; }
        header p { opacity: 0.9; font-size: 0.95rem; }

        .theme-toggle {
            position: absolute; top: 15px; right: 20px;
            background: rgba(255,255,255,0.2); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            transition: background 0.3s;
        }
        .theme-toggle:hover { background: rgba(255,255,255,0.35); }

        .toolbar {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 15px; flex-wrap: wrap;
        }

        .toolbar input[type="date"] {
            padding: 10px 15px; font-size: 1rem;
            border: 2px solid var(--border-color); border-radius: 8px;
            outline: none; transition: border-color 0.3s;
            background-color: var(--input-bg); color: var(--text-color);
        }
        .toolbar input[type="date"]:focus { border-color: var(--primary-color); }

        .date-nav { display: flex; gap: 8px; }
        .date-nav button {
            padding: 10px 15px; font-size: 0.9rem; border: none;
            background-color: var(--primary-color); color: white;
            border-radius: 8px; cursor: pointer; transition: background-color 0.3s;
        }
        .date-nav button:hover { background-color: var(--primary-dark); }
        .date-nav button:disabled { background-color: var(--border-color); cursor: not-allowed; }

        .search-box { display: flex; justify-content: center; margin-bottom: 15px; }
        .search-box input {
            width: 100%; max-width: 500px; padding: 10px 15px; font-size: 0.95rem;
            border: 2px solid var(--border-color); border-radius: 8px;
            outline: none; transition: border-color 0.3s;
            background-color: var(--input-bg); color: var(--text-color);
        }
        .search-box input::placeholder { color: var(--text-secondary); }
        .search-box input:focus { border-color: var(--primary-color); }

        .filter-tabs {
            display: flex; justify-content: center; gap: 8px;
            margin-bottom: 25px; flex-wrap: wrap;
        }
        .filter-tab {
            padding: 6px 14px; font-size: 0.85rem; border: 2px solid var(--border-color);
            border-radius: 20px; cursor: pointer; background: var(--card-bg);
            color: var(--text-secondary); transition: all 0.2s;
        }
        .filter-tab:hover { border-color: var(--primary-color); color: var(--primary-color); }
        .filter-tab.active { border-color: var(--primary-color); background: var(--primary-color); color: white; }
        .filter-tab .tab-count {
            font-size: 0.75rem; margin-left: 4px; opacity: 0.8;
        }

        .stats {
            display: flex; justify-content: center; gap: 20px;
            margin-bottom: 25px; flex-wrap: wrap;
        }
        .stat-item {
            text-align: center; padding: 15px 25px;
            background-color: var(--card-bg); border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: background-color 0.3s;
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { font-size: 0.85rem; color: var(--text-secondary); }

        .hot-list {
            background-color: var(--card-bg); border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08); overflow: hidden;
            transition: background-color 0.3s;
        }
        .hot-list-header {
            padding: 20px; background-color: var(--primary-color);
            color: white; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }

        .hot-item {
            display: flex; align-items: center; padding: 15px 20px;
            border-bottom: 1px solid var(--border-color); transition: background-color 0.2s;
        }
        .hot-item:hover { background-color: var(--hover-bg); }
        .hot-item:last-child { border-bottom: none; }
        .hot-item.hidden { display: none; }

        .hot-rank {
            width: 35px; height: 35px; display: flex; align-items: center;
            justify-content: center; font-weight: bold; font-size: 0.9rem;
            margin-right: 15px; border-radius: 8px;
            background-color: var(--bg-color); color: var(--text-secondary); flex-shrink: 0;
        }
        .hot-item:nth-child(-n+3) .hot-rank { background-color: var(--hot-color); color: white; }

        .hot-content { flex: 1; min-width: 0; }
        .hot-title {
            color: var(--text-color); text-decoration: none; font-size: 1rem;
            display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .hot-title:hover { color: var(--primary-color); }
        .hot-subtitle {
            font-size: 0.8rem; color: var(--text-secondary); display: block;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .hot-meta { display: flex; align-items: center; gap: 8px; margin-left: 15px; flex-shrink: 0; }
        .hot-count { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; }

        .status-badge {
            font-size: 0.7rem; font-weight: 600; padding: 2px 8px;
            border-radius: 10px; white-space: nowrap; text-transform: uppercase;
        }
        .status-new { background: var(--new-color); color: white; }
        .status-rising { background: var(--rising-color); color: #fff; }
        .status-hot { background: var(--hot-color); color: white; }
        .status-falling { background: var(--falling-color); color: #333; }
        .status-gone { background: var(--gone-color); color: white; }

        .velocity { font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
        .velocity.up { color: var(--rising-color); }
        .velocity.down { color: var(--falling-color); }

        .engagement {
            display: flex; gap: 8px; font-size: 0.72rem;
            color: var(--text-secondary); margin-top: 2px;
        }
        .engagement span { white-space: nowrap; }

        .loading { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--border-color);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error { text-align: center; padding: 60px 20px; color: var(--hot-color); }
        .no-data { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .search-empty { text-align: center; padding: 40px 20px; color: var(--text-secondary); }

        footer { text-align: center; padding: 30px 20px; color: var(--text-secondary); font-size: 0.85rem; }
        footer a { color: var(--primary-color); text-decoration: none; }
        footer a:hover { text-decoration: underline; }

        @media (max-width: 600px) {
            header h1 { font-size: 1.5rem; }
            .toolbar { flex-direction: column; }
            .stats { gap: 15px; }
            .stat-item { padding: 12px 20px; }
            .hot-item { padding: 12px 15px; }
            .hot-rank { width: 30px; height: 30px; font-size: 0.85rem; margin-right: 12px; }
            .hot-title { font-size: 0.95rem; }
            .theme-toggle { top: 10px; right: 10px; width: 35px; height: 35px; }
            .hot-meta { gap: 4px; margin-left: 8px; }
        }
    </style>
</head>
<body>
    <header>
        <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
            <span id="themeIcon">&#9790;</span>
        </button>
        <h1>Weibo Signal Tracker</h1>
        <p>Narrative signal monitoring since 2025-01-01</p>
    </header>

    <div class="container">
        <div class="toolbar">
            <input type="date" id="datePicker" min="2025-01-01">
            <div class="date-nav">
                <button id="prevDay" title="Previous day">&larr; Prev</button>
                <button id="today" title="Today">Today</button>
                <button id="nextDay" title="Next day">Next &rarr;</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Filter topics (Chinese or English)..." autocomplete="off">
        </div>

        <div class="filter-tabs" id="filterTabs">
            <span class="filter-tab active" data-filter="all">All <span class="tab-count" id="countAll"></span></span>
            <span class="filter-tab" data-filter="new">New <span class="tab-count" id="countNew"></span></span>
            <span class="filter-tab" data-filter="rising">Rising <span class="tab-count" id="countRising"></span></span>
            <span class="filter-tab" data-filter="hot">Hot <span class="tab-count" id="countHot"></span></span>
            <span class="filter-tab" data-filter="falling">Falling <span class="tab-count" id="countFalling"></span></span>
            <span class="filter-tab" data-filter="gone">Gone <span class="tab-count" id="countGone"></span></span>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="currentDate">-</div>
                <div class="stat-label">Date</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalTopics">-</div>
                <div class="stat-label">Topics</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="topHeat">-</div>
                <div class="stat-label">Peak Heat</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="newCount">-</div>
                <div class="stat-label">New Signals</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalEngagement">-</div>
                <div class="stat-label">Engagement</div>
            </div>
        </div>

        <div class="hot-list">
            <div class="hot-list-header">
                <span>Trending</span>
                <span id="updateTime"></span>
            </div>
            <div id="hotContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Source: <a href="https://s.weibo.com/top/summary" target="_blank" rel="noopener">Weibo Hot Search</a></p>
        <p>Project: <a href="https://github.com/ARandomGuyHere/weibo-daily-hot-search" target="_blank" rel="noopener">GitHub</a></p>
    </footer>

    <script>
        const START_DATE = '2025-01-01';
        const WEIBO_BASE_URL = 'https://s.weibo.com';

        let currentData = [];
        let activeFilter = 'all';

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        function escapeAttr(str) {
            return str.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        const datePicker = document.getElementById('datePicker');
        const hotContent = document.getElementById('hotContent');
        const currentDateEl = document.getElementById('currentDate');
        const totalTopicsEl = document.getElementById('totalTopics');
        const topHeatEl = document.getElementById('topHeat');
        const newCountEl = document.getElementById('newCount');
        const totalEngagementEl = document.getElementById('totalEngagement');
        const updateTimeEl = document.getElementById('updateTime');
        const prevDayBtn = document.getElementById('prevDay');
        const nextDayBtn = document.getElementById('nextDay');
        const todayBtn = document.getElementById('today');
        const searchInput = document.getElementById('searchInput');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const filterTabs = document.getElementById('filterTabs');

        // Dark mode
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            themeIcon.innerHTML = theme === 'dark' ? '&#9788;' : '&#9790;';
            localStorage.setItem('theme', theme);
        }
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            applyTheme(current === 'dark' ? 'light' : 'dark');
        });
        const savedTheme = localStorage.getItem('theme')
            || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);

        function formatDate(date) {
            const y = date.getFullYear(), m = String(date.getMonth()+1).padStart(2,'0'), d = String(date.getDate()).padStart(2,'0');
            return `${y}-${m}-${d}`;
        }
        function formatCount(count) {
            if (count >= 1000000) return (count/1000000).toFixed(1) + 'M';
            if (count >= 1000) return (count/1000).toFixed(1) + 'K';
            return count.toLocaleString();
        }
        function formatDisplayDate(dateStr) { return dateStr.split('-').slice(1).join('/'); }
        function getToday() {
            return new Date().toLocaleDateString('en-CA', { timeZone: 'Asia/Shanghai' });
        }
        function addDays(dateStr, days) {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + days);
            return formatDate(d);
        }
        function isValidDate(dateStr) {
            if (!dateStr || !/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return false;
            const d = new Date(dateStr + 'T00:00:00');
            return d >= new Date(START_DATE + 'T00:00:00') && d <= new Date(getToday() + 'T00:00:00');
        }

        // Filter tabs
        filterTabs.addEventListener('click', (e) => {
            const tab = e.target.closest('.filter-tab');
            if (!tab) return;
            filterTabs.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            activeFilter = tab.dataset.filter;
            applyFilters();
        });

        searchInput.addEventListener('input', () => applyFilters());

        function applyFilters() {
            const query = searchInput.value.trim().toLowerCase();
            const items = hotContent.querySelectorAll('.hot-item');
            let visible = 0;
            items.forEach(item => {
                const text = (item.getAttribute('data-text') || '').toLowerCase();
                const status = item.getAttribute('data-status') || 'hot';
                const matchText = !query || text.includes(query);
                const matchFilter = activeFilter === 'all' || status === activeFilter;
                const show = matchText && matchFilter;
                item.classList.toggle('hidden', !show);
                if (show) visible++;
            });
            const emptyMsg = hotContent.querySelector('.search-empty');
            if (visible === 0 && (query || activeFilter !== 'all') && items.length > 0) {
                if (!emptyMsg) {
                    const div = document.createElement('div');
                    div.className = 'search-empty';
                    div.textContent = 'No matching topics';
                    hotContent.appendChild(div);
                }
            } else if (emptyMsg) {
                emptyMsg.remove();
            }
        }

        function updateFilterCounts(data) {
            const counts = { all: data.length, new: 0, rising: 0, hot: 0, falling: 0, gone: 0 };
            data.forEach(d => { const s = d.status || 'hot'; if (counts[s] !== undefined) counts[s]++; });
            document.getElementById('countAll').textContent = counts.all;
            document.getElementById('countNew').textContent = counts.new || '';
            document.getElementById('countRising').textContent = counts.rising || '';
            document.getElementById('countHot').textContent = counts.hot || '';
            document.getElementById('countFalling').textContent = counts.falling || '';
            document.getElementById('countGone').textContent = counts.gone || '';
        }

        async function loadData(date) {
            hotContent.innerHTML = '<div class="loading"><div class="loading-spinner"></div><p>Loading...</p></div>';
            currentDateEl.textContent = formatDisplayDate(date);
            totalTopicsEl.textContent = '-';
            topHeatEl.textContent = '-';
            newCountEl.textContent = '-';
            totalEngagementEl.textContent = '-';
            updateTimeEl.textContent = '';
            searchInput.value = '';
            activeFilter = 'all';
            filterTabs.querySelectorAll('.filter-tab').forEach(t => t.classList.toggle('active', t.dataset.filter === 'all'));

            try {
                const cb = Math.floor(Date.now() / 60000);
                const response = await fetch(`./raw/${date}.json?v=${cb}`);
                if (!response.ok) throw new Error('Data not found');
                const data = await response.json();
                currentData = data;

                if (!data || data.length === 0) {
                    hotContent.innerHTML = '<div class="no-data"><p>No data for this date</p></div>';
                    totalTopicsEl.textContent = '0';
                    topHeatEl.textContent = '-';
                    newCountEl.textContent = '0';
                    totalEngagementEl.textContent = '-';
                    return;
                }

                totalTopicsEl.textContent = data.length;
                topHeatEl.textContent = formatCount(data[0].peakCount || data[0].count);
                newCountEl.textContent = data.filter(d => d.status === 'new').length;
                const totalEng = data.reduce((sum, d) => {
                    if (!d.engagement) return sum;
                    return sum + d.engagement.likes + d.engagement.comments + d.engagement.reposts;
                }, 0);
                totalEngagementEl.textContent = totalEng > 0 ? formatCount(totalEng) : '-';
                updateFilterCounts(data);
                renderHotList(data);
            } catch (error) {
                currentData = [];
                hotContent.innerHTML = `<div class="error"><p>Failed to load: ${escapeHtml(error.message)}</p><p style="margin-top:10px;color:var(--text-secondary);">There may be no data for this date</p></div>`;
                totalTopicsEl.textContent = '0';
                topHeatEl.textContent = '-';
                newCountEl.textContent = '0';
                totalEngagementEl.textContent = '-';
            }
        }

        function normalizeUrl(url, text) {
            if (url.startsWith('/weibo?q=')) return url;
            if (url.startsWith('http')) return url;
            if (url.startsWith('#') && url.endsWith('#')) return '/weibo?q=' + encodeURIComponent(url);
            return '/weibo?q=' + encodeURIComponent('#' + text + '#');
        }

        function renderHotList(data) {
            const html = data.map((item, index) => {
                const normalizedUrl = normalizeUrl(item.url, item.text);
                const fullUrl = normalizedUrl.startsWith('http') ? normalizedUrl : WEIBO_BASE_URL + normalizedUrl;
                const safeText = escapeHtml(item.text);
                const safeUrl = escapeAttr(fullUrl);
                const safeTextEn = item.textEn ? escapeHtml(item.textEn) : '';
                const enLine = safeTextEn && safeTextEn !== safeText
                    ? `<span class="hot-subtitle">${safeTextEn}</span>` : '';
                const engLine = item.engagement && item.engagement.posts > 0
                    ? `<div class="engagement"><span>\u{1F4AC} ${formatCount(item.engagement.comments)}</span><span>\u{1F501} ${formatCount(item.engagement.reposts)}</span><span>\u{2764} ${formatCount(item.engagement.likes)}</span></div>` : '';
                const searchText = escapeAttr(item.text + (item.textEn ? ' ' + item.textEn : ''));
                const status = item.status || 'hot';

                let badge = '';
                if (status === 'new') badge = '<span class="status-badge status-new">NEW</span>';
                else if (status === 'rising') badge = '<span class="status-badge status-rising">RISING</span>';
                else if (status === 'falling') badge = '<span class="status-badge status-falling">FADING</span>';
                else if (status === 'gone') badge = '<span class="status-badge status-gone">GONE</span>';

                let vel = '';
                if (item.velocity && item.velocity !== 0 && status !== 'new' && status !== 'gone') {
                    const cls = item.velocity > 0 ? 'up' : 'down';
                    const sign = item.velocity > 0 ? '+' : '';
                    vel = `<span class="velocity ${cls}">${sign}${item.velocity}%</span>`;
                }

                return `
                    <div class="hot-item" data-text="${searchText}" data-status="${status}">
                        <span class="hot-rank">${index + 1}</span>
                        <div class="hot-content">
                            <a href="${safeUrl}" class="hot-title" target="_blank" rel="noopener" title="${escapeAttr(item.text)}">
                                ${safeText}
                            </a>
                            ${enLine}
                            ${engLine}
                        </div>
                        <div class="hot-meta">
                            ${badge}
                            ${vel}
                            <span class="hot-count">${formatCount(item.count)}</span>
                        </div>
                    </div>`;
            }).join('');
            hotContent.innerHTML = html;
        }

        function updateNavButtons(date) {
            prevDayBtn.disabled = !isValidDate(addDays(date, -1));
            nextDayBtn.disabled = !isValidDate(addDays(date, 1));
        }

        function setDate(date) {
            if (!isValidDate(date)) date = getToday();
            datePicker.value = date;
            loadData(date);
            updateNavButtons(date);
            window.location.hash = date;
        }

        document.addEventListener('keydown', (e) => {
            if (document.activeElement === searchInput) return;
            if (e.key === 'ArrowLeft') prevDayBtn.click();
            else if (e.key === 'ArrowRight') nextDayBtn.click();
            else if (e.key === '/' || (e.key === 'f' && (e.metaKey || e.ctrlKey))) {
                e.preventDefault(); searchInput.focus();
            }
        });
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { searchInput.value = ''; searchInput.blur(); applyFilters(); }
        });

        datePicker.addEventListener('change', (e) => setDate(e.target.value));
        prevDayBtn.addEventListener('click', () => {
            const p = addDays(datePicker.value || getToday(), -1);
            if (isValidDate(p)) setDate(p);
        });
        nextDayBtn.addEventListener('click', () => {
            const n = addDays(datePicker.value || getToday(), 1);
            if (isValidDate(n)) setDate(n);
        });
        todayBtn.addEventListener('click', () => setDate(getToday()));

        function init() {
            datePicker.max = getToday();
            const hashDate = window.location.hash.slice(1);
            setDate(isValidDate(hashDate) ? hashDate : getToday());
        }
        window.addEventListener('hashchange', () => {
            const h = window.location.hash.slice(1);
            if (isValidDate(h) && h !== datePicker.value) setDate(h);
        });
        init();
    </script>
</body>
</html>
